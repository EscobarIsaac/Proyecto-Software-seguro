name: Pipeline de Seguridad y Despliegue

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ test, main ]  # El PDF pide proteger test y main

jobs:
  security-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para analizar diferencias de c√≥digo

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas scikit-learn numpy joblib pytest

    # 1. EJECUCI√ìN DEL MODELO (Etapa 1 del PDF)
    - name: Ejecutar Modelo de Detecci√≥n
      id: scan
      run: |
        echo "Iniciando an√°lisis de seguridad..."
        # Ejecutamos el script. Si encuentra vulnerabilidad, debe devolver exit code 1
        python demo_vulnerabilities.py
      [cite_start]continue-on-error: false  # CAMBIO: Si falla, bloquea el pipeline 

    # 2. COMENTAR EN EL PR
    - name: Comment PR with results
      if: always() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
             // Intenta leer el reporte si existe
             if (fs.existsSync('reports/vulnerability_report.html')) {
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: "## üõ°Ô∏è Reporte de Seguridad\n\nEl an√°lisis ha finalizado. Revisa los resultados arriba."
                });
             }
          } catch (e) { console.log(e); }

    # 3. NOTIFICACI√ìN TELEGRAM (Obligatorio )
    - name: Notificar a Telegram
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          üõ°Ô∏è **Reporte de Seguridad - Software Seguro**
          
          üë§ Usuario: ${{ github.actor }}
          repository: ${{ github.repository }}
          
          Estado del An√°lisis: ${{ job.status }}
          
          Ver detalles: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # 4. EJECUCI√ìN DE PRUEBAS (Etapa 2 del PDF [cite: 45])
  unit-tests:
    needs: security-check
    runs-on: ubuntu-latest
    if: success() # Solo corre si el chequeo de seguridad pas√≥
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: pip install pytest
      - name: Run Tests
        run: pytest