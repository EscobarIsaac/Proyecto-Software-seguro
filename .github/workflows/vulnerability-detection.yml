name: Pipeline de Seguridad y Despliegue CI/CD

on:
  push:
    branches: [ dev ]        # Ejecutar al subir cambios a dev (para probar rÃ¡pido)
  pull_request:
    branches: [ test, main ] # Ejecutar al hacer PR hacia test o main (Requisito PDF)

jobs:
  security-check:
    name: ğŸ›¡ï¸ AnÃ¡lisis de Seguridad
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
    - name: ğŸ“¥ Clonar cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install pandas scikit-learn numpy joblib pytest

    # ETAPA 1: RevisiÃ³n de Seguridad (Requisito PDF)
    - name: ğŸ” Ejecutar Modelo de IA
      id: scan
      run: |
        echo "Iniciando anÃ¡lisis de vulnerabilidades..."
        # Si el script devuelve exit code 1 (Vulnerable), el paso fallarÃ¡
        python demo_vulnerabilities.py
      continue-on-error: false  # IMPORTANTE: Esto bloquea el pipeline si es vulnerable

    # NotificaciÃ³n TELEGRAM (Requisito PDF - 3 Puntos)
    - name: ğŸ“± Notificar a Telegram
      if: always() # Se envÃ­a siempre, pase o falle
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ğŸ›¡ï¸ **Reporte de Software Seguro**
          
          ğŸ‘¤ Por: ${{ github.actor }}
          ğŸ“‚ Repo: ${{ github.repository }}
          
          ğŸ“Š Estado: ${{ job.status }}
          
          ğŸ”— Ver detalles: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # ETAPA 2: Pruebas Unitarias (Solo si es SEGURO)
  unit-tests:
    name: ğŸ§ª Pruebas Unitarias
    needs: security-check     # Espera a que pase la seguridad
    runs-on: ubuntu-latest
    if: success()             # Solo corre si el cÃ³digo es SEGURO
    steps:
      - uses: actions/checkout@v4
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Instalar pytest
        run: pip install pytest
      - name: Ejecutar Tests
        run: pytest